# Refactoring Summary - December 6, 2025

## Table of Contents
- [Changes Implemented](#changes-implemented)
  - [1. Per-Database Frequency Settings](#1-per-database-frequency-settings)
  - [2. Token Storage and Management](#2-token-storage-and-management)
  - [3. Database Migration](#3-database-migration)
  - [4. Admin Tools Enhancement](#4-admin-tools-enhancement)
- [Security Considerations](#security-considerations)
- [Migration Instructions](#migration-instructions)
- [Breaking Changes](#breaking-changes)
  - [API Changes](#api-changes)
  - [Data Model](#data-model)
- [Future Enhancements](#future-enhancements)
- [Testing Checklist](#testing-checklist)
- [Rollback Plan](#rollback-plan)
- [Notes](#notes)

## Overview
This document summarizes the major refactoring changes made to implement per-database frequency settings and secure token storage.

## Changes Implemented

### 1. Per-Database Frequency Settings

#### Backend Changes
- **Models (`backend/app/models.py`)**:
  - Added `frequency` field to `NotionDatabase` model (daily/weekly/custom)
  - Removed `frequency` field from `EmailSettings` model
  - Added `NotionToken` model for storing API tokens securely

- **API Endpoints (`backend/app/database.py`)**:
  - Updated `POST /api/databases` to accept frequency parameter
  - Updated `PUT /api/databases/<id>` to allow frequency updates
  - Added token management endpoints:
    - `GET /api/databases/tokens` - List user's tokens
    - `POST /api/databases/tokens` - Add new token
    - `PUT /api/databases/tokens/<id>` - Update token
    - `DELETE /api/databases/tokens/<id>` - Delete token

- **User Settings (`backend/app/user.py`)**:
  - Removed frequency handling from email settings endpoint
  - Frequency is now managed per-database

#### Frontend Changes
- **Databases Page (`frontend/src/pages/Databases.js`)**:
  - Added frequency dropdown for each database in the list view
  - Inline frequency editing with immediate update
  - Added token management:
    - Radio button to choose between stored token or new token
    - Token selector dropdown showing stored tokens
    - Privacy notice about token storage
    - Token manager modal to view stored tokens
  - Updated form to include frequency field
  - Added token-related UI components

- **Settings Page (`frontend/src/pages/Settings.js`)**:
  - Removed global frequency setting
  - Added informational notice directing users to Databases page for frequency settings

### 2. Token Storage and Management

#### Backend Changes
- **New Model: `NotionToken`**:
  - `id` - Primary key
  - `user_id` - Foreign key to users
  - `token` - Encrypted Notion API token
  - `token_name` - Optional friendly name for the token
  - `is_active` - Active status flag
  - `created_at`, `updated_at` - Timestamps

- **Updated Model: `NotionDatabase`**:
  - Added `token_id` field - Foreign key to `NotionToken`
  - Relationship to stored tokens

- **Updated User Model**:
  - Added `notion_tokens` relationship

#### API Flow Changes
**Adding a Database:**
1. User can either:
   - Select an existing stored token (via `token_id`)
   - Provide a new token (via `notion_api_key`)
2. If new token provided, it's automatically stored
3. Database is created with reference to the token

**Updating a Database:**
1. Can update frequency independently
2. Can reassign to different token
3. Can provide new token which gets stored

**Token Management:**
1. Users can view all stored tokens
2. Tokens show how many databases use them
3. Cannot delete a token that's in use
4. Token values are masked in the UI for security

#### Frontend Changes
- **Token Privacy Notice**: Clear information that tokens are stored
- **Token Selection**: Choice between stored and new tokens
- **Token Manager**: Modal view of all stored tokens with usage counts
- **Inline Updates**: Quick frequency changes without full form

### 3. Database Migration

**Migration File**: `backend/migrations/versions/002_add_token_storage_and_per_db_frequency.py`

**Upgrade Steps**:
1. Create `notion_tokens` table
2. Add `frequency` column to `notion_databases` (default: 'daily')
3. Add `token_id` column to `notion_databases`
4. Migrate existing frequency data from `email_settings` to `notion_databases`
5. Remove `frequency` column from `email_settings`

**Downgrade Steps**:
1. Add `frequency` back to `email_settings`
2. Migrate frequency data back (uses first database's frequency per user)
3. Remove `token_id` and `frequency` from `notion_databases`
4. Drop `notion_tokens` table

### 4. Admin Tools Enhancement

**New Command**: `./admin.sh view-tokens`

Shows for a given user:
- All stored Notion tokens with masked values
- Token names and active status
- Databases connected to each token
- Database frequency settings
- Databases without tokens (legacy)

**Updated Command**: `./admin.sh view-user`
- Now shows frequency for each database
- Removed global frequency display

## Security Considerations

1. **Token Storage**: Tokens are stored in the database but should be encrypted at rest (consider adding encryption layer)
2. **Token Display**: Tokens are never fully displayed in frontend
3. **Privacy Notice**: Users are informed about token storage before adding databases
4. **Token Deletion**: Prevents deletion of tokens in use
5. **User Ownership**: All token operations verify user ownership

## Migration Instructions

1. **Backup Database**:
   ```bash
   ./admin.sh backup
   ```

2. **Run Migration**:
   ```bash
   docker-compose exec backend flask db upgrade
   ```

3. **Verify Migration**:
   ```bash
   ./admin.sh view-user
   # Check that existing databases have frequency settings
   ```

## Breaking Changes

### API Changes
- `POST /api/databases` now accepts optional `frequency` and `token_id` parameters
- `PUT /api/databases/<id>` now accepts `frequency` parameter
- `PUT /api/user/settings` no longer accepts `frequency` parameter

### Data Model
- `email_settings.frequency` column removed
- `notion_databases.frequency` column added
- `notion_databases.token_id` column added
- `notion_tokens` table added

## Future Enhancements

1. **Token Encryption**: Implement encryption for stored tokens
2. **Token Expiry**: Add expiration dates for tokens
3. **Token Validation**: Periodic validation of stored tokens
4. **Multiple Tokens per Database**: Allow fallback tokens
5. **Token Permissions**: Track what permissions each token has
6. **Audit Log**: Track when tokens are used and by which operations

## Testing Checklist

- [ ] Create new database with new token
- [ ] Create new database with stored token
- [ ] Update database frequency inline
- [ ] Edit database and change token
- [ ] View tokens in token manager
- [ ] Delete token (should fail if in use)
- [ ] Verify privacy notice is shown
- [ ] Test migration on copy of production data
- [ ] Verify admin script view-tokens command
- [ ] Check that old databases get default frequency
- [ ] Verify email settings no longer show frequency

## Rollback Plan

If issues arise:

1. **Stop Services**:
   ```bash
   docker-compose down
   ```

2. **Restore Database Backup**:
   ```bash
   # Restore from backup created earlier
   ```

3. **Revert Code**:
   ```bash
   git revert <commit-hash>
   ```

4. **Downgrade Migration** (if partially migrated):
   ```bash
   docker-compose exec backend flask db downgrade
   ```

## Notes

- Existing databases will automatically get 'daily' frequency after migration
- Users will need to manually set preferred frequency for each database
- Tokens provided before this change were not stored - users will need to re-enter them
- The migration preserves the user's previous global frequency setting by applying it to all their databases
